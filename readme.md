# KPIアプリ 操作ガイド

最終更新: 2025-09-25
対象: KPI一覧の閲覧・比較・エクスポートを行う担当者向け

---

## 1) アプリの目的とできること

* **目的**: 計測期間を指定し、該当する**選手のKPI**をまとめて取得・表示・比較します。
* **できること**

  * 期間指定 → 選手取得 → KPI表示（モード切替: **RS/FLY**）
  * 表のソート／フィルタ（数値レンジ）
  * 複数行選択・右クリックによるクリップボードへのコピー
  * CSVエクスポート
  * 再読み込み（Ctrl+R） による最新反映

> 使う人が迷わないこと・再現可能な集計を重視しています。DBのデータ自体は変更しません（表示・出力用アプリ）。

---

## 2) 前提とデータの扱い

* **期間と選手の紐づけ**: 指定した期間に対して、有効な選手の測定データを取得します。
* **モード（RS/FLY）**: モードにより表示するKPI列が異なります。

  * **RS表示**: `Time000to625`, `Time625to125`, `Time000to125`
  * **FLY表示**: `Time000to100`, `Time100to200`, `Time000to200`
* **表示上の約束**

  * **赤字 = 補完値（imputed）**: 欠損や区間補完により推定された値。比較時は参考扱いにしてください。
  * **時刻・小数の表示**は表の書式に従います。コピーやCSV出力でも概ね同等の書式になります。

> 行の削除は**表示上のみ**で、DBのレコードには**一切影響しません**。

---

## 3) 基本の操作フロー

1. **期間を選ぶ**: 画面上部の**Start / End**（JST）を指定します。
2. **選手一覧を取得**: **Get players list** をクリック。右側に候補が表示されます。
3. **選手を選択**: 単一または複数選択します（Ctrl/Shiftで拡張選択）。
4. **KPIを表示**: **Show KPIs** をクリック。KPIページが開きます。
5. **よく使う操作**

   * **モード切替**: **RS / FLY** をトグル
   * **ソート**: ヘッダをクリック
   * **フィルタ**: 上部に**min / max** を入力（数値レンジ）。
   * **再読み込み**: **Ctrl+R**（KPIページを更新。選手選択からやり直さずに反映）
   * **CSV出力**: **Export to CSV**（内部列は自動除外）

>  **Show All Columns** の切替で、必要に応じて列を広く・少なく表示できます。\
>  **settings.json** でデフォルトで表示する列を変更することができます。


## 4) 注意点とトラブルシュート

**動作が不安定**
- 本アプリはリアルタイムでデータサーバーにアクセスしています。そのため、ネットワークが不安定な場合は正しく動作しないためwifi等の環境を確認してください。

---


## 開発者向け: ロジックとエラー条件（実装メモ）

### 1. データ取得ロジック

* **対象DB**: trackview
* **接続方式**: mysql+pymysql
* **利用テーブル**: 
  - passing(timestamp, decoder_id, transponder_id, …) … 通過ログ
  - transponder_user(id, transponder_id, user_id, since, until) … トランスポンダ割当（期間管理）
  - user(id, first_name, last_name, …) … 選手マスタ
* **結合**: transponder_idで結合。ただしtransponder_idは別期間同一IDの可能性があるため、startがsinceとuntilの間に含まれるものを採用
* **上限**: 取得件数に**LIMIT（例: 10000）**を設ける。超過時は**切り捨て**。

### 2. KPI生成ロジック

* **時刻変換**: 取得後、表示用に **UTC→JST** へ統一。
* **地点名マッピング**: `decoder_id` → 表示名（地点）に変換。
* **ラップ分割**: 下記ルールに従い1回目の奥のPursuit line（FP）から2回目のFinish line（0m）を切り出し。
* **分割ルール**: 
  * timestamp を datetime 変換し、欠損は除去 → 時刻昇順に並べ替え。
  * その周で最初に現れた FP または 0m を アンカーとして採用。
  * 同じアンカーが再び出た瞬間に現ラップを確定。
  * _2ndは次のラップの_startをシフト
* **欠損補完**: 区間間の距離に応じた線形補完。補完列に `imputed__*` を付与。
* **KPI算出**: 区間時間などのkpiを計算。**元データが補完値**なら、**KPI側にも補完フラグ**を伝搬。

### 3. 認証/エラーの扱い

* **アプリ認証**: アプリ起動時自動でexeファイルのlicense.txtの文字列を取得。ファイルがない場合やパスワードが異なる場合は手動入力画面に移行。
* **選手選択SQLエラー**: 選択期間内に選手がいない場合、警告画面を出力し選手選択画面を保持。選手選択せずにkpi画面に移行しようとした場合も同様にページ遷移せず選手選択画面を保持。
* 

